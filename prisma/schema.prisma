generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ---------------- Enums ----------------
 */

enum MemberStatus {
  LAOBAN
  PEIWAN
}

enum EntryKind {
  DIANDAN
  DASHANG
  TIXIAN
  RECHARGE
}

enum PeiwanStatus {
  busy
  free
}

enum OrderMode {
  REALNAME
  ANONYMOUS
}

enum OrderStatus {
  PENDING
  RUNNING
  ENDED
  DECLINED
  CANCELED
  EXPIRED
}

enum RechargeOrderStatus {
  PENDING
  PAID
  FAILED
}

enum QuotationCode {
  Q1
  Q2
  Q3
  Q4
  Q5
  Q6
  Q7
}

enum PeiwanSex {
  小姐姐
  小哥哥
}

enum PeiwanType {
  娱乐陪玩
  技术陪玩
  大神陪玩
}

enum PeiwanLevel {
  优选陪玩
  明星陪玩
  殿堂陪玩
}

enum RedEnvelopeStatus {
  ACTIVE
  FINISHED
  REFUNDED
}

enum LotteryPool {
  NORMAL   // 银色
  MEDIUM   // 金色
  ADVANCED // 高级（有限）
  SPECIAL  // 特级（有限）
}

enum LotteryPrizeType {
  COUPON
  GIFT
  OTHER
  SELFUSE
}

/**
 * ---------------- Models ----------------
 */

model Member {
  // Primary key is the Discord user id
  discordUserId String       @id
  status        MemberStatus @default(LAOBAN)

  // Money
  totalBalance Decimal @default(0) @db.Decimal(19, 4)
  income       Decimal @default(0) @db.Decimal(19, 4)
  recharge     Decimal @default(0) @db.Decimal(19, 4)
  totalSpent   Decimal @default(0) @db.Decimal(19, 4)
  VIPRoleOptOut Boolean @default(false)

  // Payout rate (user receives this share of gross), default 75%
  commissionRate Decimal @default(0.75) @db.Decimal(7, 6)

  // Relations
  commissionFrom Commission[] @relation("CommissionFrom")
  commissionTo   Commission[] @relation("CommissionTo")

  sentTransactions     Transaction[] @relation("FromMember")
  receivedTransactions Transaction[] @relation("ToMember")
  zpayRechargeOrders   ZPayRechargeOrder[]

  // One-to-one: every 陪玩 is a member; not every member is a 陪玩
  peiwan PEIWAN? @relation("MemberToPeiwan")

  // Orders (reverse edges)
  ordersAsHost   Order[] @relation("HostOrders")
  ordersAsWorker Order[] @relation("WorkerOrders")

  // Heart counters (from → to)
  heartFrom HeartCounter[] @relation("HeartFrom")
  heartTo   HeartCounter[] @relation("HeartTo")

  // Lottery draws
  lotteryDraws LotteryDraw[]
  lotteryPity  LotteryPity?

  // Back-relation for WorkerLock (one active lock at most)
  workerLock WorkerLock? @relation("MemberWorkerLock")

  // Invite link reward records
  inviteRewardsGiven    InviteLinkUsage[] @relation("MemberToInviteLinkUsage")
  inviteRewardsReceived InviteLinkUsage[] @relation("InviteeToInviteLinkUsage")

  // Referral relations
  referralInviter Referral[] @relation("ReferralInviter")
  referralInvitee Referral?  @relation("ReferralInvitee")

  // Display name inside target Discord guild
  serverDisplayName String?
}

model Transaction {
  Transid   String   @id @default(cuid())
  orderID   Int      @unique @default(autoincrement())
  fromId    String
  toId      String
  amount    Decimal  @db.Decimal(19, 4)
  feeAmount Decimal  @db.Decimal(19, 4)
  netAmount Decimal  @db.Decimal(19, 4)
  createdAt DateTime @default(now())

  commissionById    Commission? @relation("commissionById")
  commissionByOrder Commission? @relation("commissionByOrder")

  from Member @relation("FromMember", fields: [fromId], references: [discordUserId])
  to   Member @relation("ToMember", fields: [toId], references: [discordUserId])
}

model Withdraw {
  id         String   @id @default(dbgenerated("concat('W', nextval('\"Withdraw_id_seq\"'::regclass))"))
  discordId  String
  createdAt  DateTime @default(now())
  amount     Decimal  @db.Decimal(19, 4)
  method     String
  notifiedAt DateTime?

  @@index([discordId])
}

model IndividualTransaction {
  transactionId      String   @id @default(dbgenerated("concat('IT', nextval('\"IndividualTransaction_transactionId_seq\"'::regclass))"))
  timeCreatedAt      DateTime @default(now())
  discordId          String
  thirdPartydiscordId String
  balanceBefore      Decimal  @db.Decimal(19, 4)
  amountChange       Decimal  @db.Decimal(19, 4)
  balanceAfter       Decimal  @db.Decimal(19, 4)
  typeOfTransaction  String

  @@index([discordId])
}

enum CouponType {
  DISCOUNT_90
  DISCOUNT_80
}

enum CouponStatus {
  ACTIVE
  USED
  EXPIRED
}

model Coupon {
  id        String      @id @default(dbgenerated("concat('C', nextval('\"Coupon_id_seq\"'::regclass))"))
  discordId String
  type      CouponType
  status    CouponStatus @default(ACTIVE)
  issuedAt  DateTime    @default(now())
  expiresAt DateTime
  consumedAt DateTime?
  orderId   String?
  discountAmount Decimal? @db.Decimal(19, 4)
}

model Commission {
  transactionId String   @id
  orderID       Int      @unique @default(autoincrement())
  fromId        String
  toId          String
  feeAmount     Decimal  @db.Decimal(19, 4)
  createdAt     DateTime @default(now())

  transactionByID    Transaction @relation("commissionById", fields: [transactionId], references: [Transid], onDelete: Cascade)
  transactionByOrder Transaction @relation("commissionByOrder", fields: [orderID], references: [orderID], onDelete: Cascade)

  from Member @relation("CommissionFrom", fields: [fromId], references: [discordUserId])
  to   Member @relation("CommissionTo", fields: [toId], references: [discordUserId])
}

model InteractionLog {
  Interid   String   @id @default(cuid())
  memberId  String?
  command   String?
  payload   Json?
  createdAt DateTime @default(now())
}

model Gift {
  GiftName String   @id
  price    Decimal? @db.Decimal(19, 4)
  url_link String?
  rate     Decimal  @default(1) @db.Decimal(10, 2)

}

model Recharge {
  RechargeID String  @id @default(dbgenerated("concat('C', nextval('\"Recharge_RechargeID_seq\"'::regclass))"))
  amount     Decimal @db.Decimal(19, 4)
  toWhom     String
  fromWhom   String  @default("1421651539247894549")
  createdAt  DateTime @default(now())
}

model ZPayRechargeOrder {
  id            String               @id @default(dbgenerated("concat('ZPAY', replace((gen_random_uuid())::text, '-'::text, ''::text))"))
  outTradeNo    String               @unique
  discordUserId String
  amount        Decimal              @db.Decimal(19, 4)
  channel       String
  status        RechargeOrderStatus  @default(PENDING)
  gatewayTradeNo String?
  notifyPayload Json?
  createdAt     DateTime             @default(now())
  paidAt        DateTime?

  member Member @relation(fields: [discordUserId], references: [discordUserId], onDelete: Cascade, onUpdate: Cascade)

  @@index([status, createdAt])
}

model PEIWAN {
  PEIWANID      Int    @id
  discordUserId String @unique

  // Required: every 陪玩 must have a default quotation *code*
  defaultQuotationCode QuotationCode

  // Price slots (include DEFAULT)
  quotation_Q1 Decimal? @db.Decimal(10, 2)
  lolPrice    Decimal? @db.Decimal(10, 2)
  valPrice    Decimal? @db.Decimal(10, 2)
  deltaPrice  Decimal? @db.Decimal(10, 2)
  csgoPrice   Decimal? @db.Decimal(10, 2)
  narakaPrice Decimal? @db.Decimal(10, 2)
  apexPrice   Decimal? @db.Decimal(10, 2)

  // Payout rate copy on PEIWAN (synced → Member via DB trigger)
  commissionRate Decimal @default(0.75) @db.Decimal(7, 6)

  totalEarn Decimal      @default(0) @db.Decimal(19, 4)
  balance   Decimal      @default(0) @db.Decimal(19, 4)
  MP_url    String?
  status    PeiwanStatus @default(free)
  serverDisplayName String?
  techTag   Boolean      @default(false)
  sex       PeiwanSex    @default(小姐姐)
  exclusive Boolean      @default(false)
  type      PeiwanType   @default(娱乐陪玩)
  level     PeiwanLevel  @default(优选陪玩)
  LOL       Boolean      @default(false)
  CSGO      Boolean      @default(false)
  Valorant  Boolean      @default(false)
  Naraka    Boolean      @default(false)
  OW2       Boolean      @default(false)
  APEX      Boolean      @default(false)
  deltaForce Boolean     @default(false)
  marvel    Boolean      @default(false)
  singer    Boolean      @default(false)
  PUBG      Boolean      @default(false)
  TFT       Boolean      @default(false)
  R6        Boolean      @default(false)
  tarkov    Boolean      @default(false)
  chat      Boolean      @default(false)
  steam     Boolean      @default(false)
  DOTA      Boolean      @default(false)
  COD       Boolean      @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  member Member @relation("MemberToPeiwan", fields: [discordUserId], references: [discordUserId], onDelete: Cascade)

  // Back-relation to Order for the peiwan relation
  orders Order[] @relation("PeiwanOrders")

  @@index([status])
}

model Order {
  id       String @id @default(cuid()) // orderId
  hostId   String
  workerId String
  peiwanId Int
  displayNo Int @default(autoincrement()) @unique

  host   Member @relation("HostOrders", fields: [hostId], references: [discordUserId], onDelete: Restrict)
  worker Member @relation("WorkerOrders", fields: [workerId], references: [discordUserId], onDelete: Restrict)
  peiwan PEIWAN @relation("PeiwanOrders", fields: [peiwanId], references: [PEIWANID], onDelete: Restrict)

  mode   OrderMode
  status OrderStatus @default(PENDING)

  // Price snapshot
  quotationCode QuotationCode
  unitPrice     Decimal       @db.Decimal(10, 2)

  // Timing (5-min delayed stopwatch billing)
  createdAt        DateTime  @default(now())
  acceptedAt       DateTime?
  billableStartAt  DateTime? // = acceptedAt + 5min
  stopwatchStartAt DateTime? // = acceptedAt
  cutoffAt         DateTime? // = acceptedAt + maxMinutes

  // Recalc snapshot & telemetry
  maxMinutesAtAccept Int?
  lastRecalcAt       DateTime?
  chargedMinutes     Int      @default(0)
  chargedGross       Decimal  @default(0) @db.Decimal(19, 4)

  endedAt      DateTime?
  totalMinutes Int? // ceil((endedAt - stopwatchStartAt)/60)

  // Money (gross two-decimal; payout snapshot is worker share)
  grossAmount    Decimal? @db.Decimal(18, 2)
  commissionRate Decimal? @db.Decimal(7, 6) // snapshot of worker payout share at accept
  netAmount      Decimal? @db.Decimal(18, 2)

  interId String?

  // Back-relation for WorkerLock (one active lock per order at most)
  workerLock WorkerLock? @relation("OrderWorkerLock")

  @@index([status, cutoffAt])
  @@index([workerId, status])
  @@index([hostId, status])
}

model PeiwanDeletion {
  peiwanId      Int      @id
  discordUserId String
  deletedBy     String?
  deletedAt     DateTime @default(now())

  @@index([discordUserId])
}

model WorkerLock {
  workerId  String   @unique
  orderId   String   @unique
  createdAt DateTime @default(now())

  // Name relations to avoid ambiguity
  worker Member @relation("MemberWorkerLock", fields: [workerId], references: [discordUserId], onDelete: Cascade)
  order  Order  @relation("OrderWorkerLock", fields: [orderId], references: [id], onDelete: Cascade)
}

model HeartCounter {
  id           Int    @id @default(autoincrement())
  fromMemberId String
  toMemberId   String
  total        Int    @default(0)

  fromMember Member @relation("HeartFrom", fields: [fromMemberId], references: [discordUserId], onDelete: Cascade)
  toMember   Member @relation("HeartTo", fields: [toMemberId], references: [discordUserId], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fromMemberId, toMemberId])
}

model RedEnvelope {
  id              String             @id @default(cuid())
  creatorId       String
  totalAmount     Decimal            @db.Decimal(19, 4)
  remainingAmount Decimal            @db.Decimal(19, 4)
  totalCount      Int
  remainingCount  Int
  note            String?
  status          RedEnvelopeStatus  @default(ACTIVE)
  expiresAt       DateTime
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  messageId       String?
  channelId       String?
  refundedAmount  Decimal?           @db.Decimal(19, 4)
  incomePool      Decimal            @db.Decimal(19, 4)
  rechargePool    Decimal            @db.Decimal(19, 4)

  @@index([status, expiresAt])
}

model LotteryPrize {
  id           String      @id @default(cuid())
  name         String
  pool         LotteryPool
  type         LotteryPrizeType @default(COUPON)
  weight       Int
  unlimited    Boolean     @default(false)
  stock        Int?
  imageUrl     String?
  active       Boolean     @default(true)

  draws LotteryDraw[]
}

model CommissionBuff {
  userId    String   @id @map("user_id")
  boost     Decimal  @db.Decimal(10, 4)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("commission_buff")
}

model FlowBuff {
  userId         String   @id @map("user_id")
  remainingExtra Decimal  @db.Decimal(19, 4) @map("remaining_extra")
  expiresAt      DateTime @map("expires_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("flow_buff")
}

model LotteryDraw {
  id        String      @id @default(cuid())
  nonce     String      @unique
  requestId String?
  userId    String
  pool      LotteryPool
  prizeId   String?
  cost      Decimal     @db.Decimal(19, 4)
  random    Float?
  createdAt DateTime    @default(now())
  status    LotteryStatus @default(UNUSED)
  code      String?       @unique
  expiresAt DateTime?
  consumeAt DateTime?

  prize  LotteryPrize? @relation(fields: [prizeId], references: [id])
  member Member        @relation(fields: [userId], references: [discordUserId])

  @@index([userId, createdAt])
  @@index([pool, createdAt])
}

model LotteryPity {
  userId    String   @id
  missCount Int      @default(0)
  updatedAt DateTime @updatedAt

  user Member @relation(fields: [userId], references: [discordUserId], onDelete: Cascade, onUpdate: Cascade)
}

enum LotteryStatus {
  UNUSED
  USED
  EXPIRED
}

enum ReferralType {
  LAOBAN
  PEIWAN
}

/// 手工指定唯一邀请人及类型（老板/陪玩）
model Referral {
  inviteeId String @id
  inviterId String
  type      ReferralType
  createdAt DateTime @default(now())

  inviter Member @relation("ReferralInviter", fields: [inviterId], references: [discordUserId])
  invitee Member @relation("ReferralInvitee", fields: [inviteeId], references: [discordUserId])
  payouts ReferralPayout[]

  @@index([inviterId, type])
}

/// 记录每单邀请提成的发放（幂等：referralId+orderId 唯一）
model ReferralPayout {
  id         String   @id @default(cuid())
  referralId String
  orderId    String
  amount     Decimal  @db.Decimal(19, 4)
  createdAt  DateTime @default(now())

  referral Referral @relation(fields: [referralId], references: [inviteeId], onDelete: Cascade, onUpdate: Cascade)

  @@unique([referralId, orderId])
}

/// 记录用户是否曾经进入过目标 Guild（只插入一次，用于防止重复邀请奖励）
model GuildJoinRecord {
  userId       String   @id
  guildId      String
  firstJoinedAt DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([guildId])
}

/// 邀请链接使用并发放 2 元奖励的流水（不依赖 Referral 表）
model InviteLinkUsage {
  id         String   @id @default(cuid())
  guildId    String
  inviteeId  String   @unique
  inviterId  String
  code       String?
  rewardedAt DateTime @default(now())
  rewardAmount Decimal @db.Decimal(19, 4)
  createdAt  DateTime @default(now())

  inviter Member @relation("MemberToInviteLinkUsage", fields: [inviterId], references: [discordUserId], onDelete: Cascade)
  invitee Member @relation("InviteeToInviteLinkUsage", fields: [inviteeId], references: [discordUserId], onDelete: Cascade)

  @@index([guildId, inviterId])
}
